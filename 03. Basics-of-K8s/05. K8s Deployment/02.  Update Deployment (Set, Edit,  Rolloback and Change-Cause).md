# 🚀 **Kubernetes - Update Deployment**

---

## 🧾 **Description**

**Learn and Implement Kubernetes Update Deployment**

---

## 🧠 **Step-00: Introduction**

We can update deployments using two options:

| Option                  | Description                              | When to Use              |
| ----------------------- | ---------------------------------------- | ------------------------ |
| 🧱 **Set Image**        | Update container image directly from CLI | Quick version upgrade    |
| 🛠️ **Edit Deployment** | Open deployment YAML for manual edit     | Deep or multiple changes |

---

## ⚙️ **Step-01: Updating Application version V1 → V2 using `Set Image` Option**

### 🎯 Objective

Upgrade the deployment image from **version 1.0.0 → 2.0.0** using the `kubectl set image` command.
This performs a **rolling update** — ensuring **zero downtime** for users. ⚡

---

### 🔍 **Update Deployment**

> 🧠 **Observation:**
> Please check the **container name** in `spec.containers.name` YAML output before running the `set image` command.

```bash
# Get Container Name from current deployment
kubectl get deployment my-first-deployment -o yaml
```

---

```bash
# Update Deployment - SHOULD WORK NOW
kubectl set image deployment/<Deployment-Name> <Container-Name>=<Container-Image> 
kubectl set image deployment/my-first-deployment kubenginx=stacksimplify/kubenginx:2.0.0 
```

---

### 🧩 **Verify Rollout Status (Deployment Status)**

> 🧠 **Observation:**
> By default, rollout happens in a **rolling update model**, so **no downtime** occurs.

```bash
# Verify Rollout Status 
kubectl rollout status deployment/my-first-deployment

# Verify Deployment
kubectl get deploy
```

---

### 🧾 **Describe Deployment**

> 🔍 **Observation:**
> Verify the **Events** section — Kubernetes automatically performs **rolling updates** when new versions are deployed.

```bash
# Descibe Deployment
kubectl describe deployment my-first-deployment
```

---

### 🧩 **Verify ReplicaSet**

> 🧠 **Observation:**
> A **new ReplicaSet** will be created for the new version.

```bash
# Verify ReplicaSet
kubectl get rs
```

---

### 🧪 **Verify Pods**

> 💡 **Observation:**
> The **Pod template hash label** of the new ReplicaSet should appear in the new pods, confirming they belong to the updated ReplicaSet.

```bash
# List Pods
kubectl get po
```

---

### 🌐 **Access the Application using Public IP**

> 🎯 You should see **Application Version: V2** whenever you access it in the browser.

```bash
# Get Load Balancer IP
kubectl get svc

# Application URL
http://<External-IP-from-get-service-output>
```

---

### 🏷️ **Update Change-Cause for the Kubernetes Deployment - Rollout History**

> 🧠 **Observation:**
> Kubernetes maintains rollout history, allowing rollback to previous versions easily.

```bash
# Verify Rollout History
kubectl rollout history deployment/my-first-deployment

# Update REVISION CHANGE-CAUSE
kubectl annotate deployment/my-first-deployment kubernetes.io/change-cause="Deployment UPDATE - App Version 2.0.0 - SET IMAGE OPTION"

# Verify Rollout History
kubectl rollout history deployment/my-first-deployment
```

---

## 🧰 **Step-02: Update the Application from V2 → V3 using `Edit Deployment` Option**

### 🧱 **Edit Deployment**

```bash
# Edit Deployment
kubectl edit deployment/<Deployment-Name> 
kubectl edit deployment/my-first-deployment 
```

---

### 🔧 **Change the Version**

Change **from 2.0.0 → 3.0.0** inside YAML:

```yaml
# Change From 2.0.0
spec:
  containers:
  - image: stacksimplify/kubenginx:2.0.0

# Change To 3.0.0
spec:
  containers:
  - image: stacksimplify/kubenginx:3.0.0
```

---

### ⚙️ **Verify Rollout Status**

> 🧠 **Observation:**
> Rollout happens in a **rolling update model** → **no downtime**.

```bash
# Verify Rollout Status 
kubectl rollout status deployment/my-first-deployment

# Describe Deployment
kubectl describe deployment/my-first-deployment
```

---

### 🧩 **Verify ReplicaSets**

> 💡 **Observation:**
> You should see **3 ReplicaSets** now (for versions V1, V2, and V3).

```bash
# Verify ReplicaSet and Pods
kubectl get rs
kubectl get po
```

---

### 🌍 **Access the Application using Public IP**

> 🎯 You should now see **Application Version: V3** when you access the URL.

```bash
# Get Load Balancer IP
kubectl get svc

# Application URL
http://<External-IP-from-get-service-output>
```

---

### 🏷️ **Update Change-Cause for the Kubernetes Deployment - Rollout History**

> 🧠 **Observation:**
> Rollout history allows you to revert to any previous version (V1/V2/V3).

```bash
# Verify Rollout History
kubectl rollout history deployment/my-first-deployment

# Update REVISION CHANGE-CAUSE
kubectl annotate deployment/my-first-deployment kubernetes.io/change-cause="Deployment UPDATE - App Version 3.0.0 - EDIT DEPLOYMENT OPTION"

# Verify Rollout History
kubectl rollout history deployment/my-first-deployment
```

---

## 📊 **Visual Summary**

### 🧩 Deployment Rollout Flow

```text
V1 ──▶ V2 ──▶ V3
 │      │      │
 │      │      └── New ReplicaSet Created
 │      └── Old ReplicaSet Scaled Down
 └── Rollback Possible Anytime
```

---

## 🧠 **Comparison: Set Image vs Edit Deployment**

| Feature       | `Set Image`                 | `Edit Deployment`               |
| ------------- | --------------------------- | ------------------------------- |
| Update Type   | CLI Command                 | Manual YAML Edit                |
| Speed         | Fast ⚡                      | Slower ⏳                        |
| Best For      | Quick image version changes | Structural or multi-field edits |
| Risk of Error | Low                         | Higher (manual edit)            |
| Downtime      | None                        | None (Rolling Update)           |

---

## 🧾 **Quick Reference Table**

| Action                  | Command                                                               | Purpose                    |
| ----------------------- | --------------------------------------------------------------------- | -------------------------- |
| View Current Deployment | `kubectl get deploy`                                                  | Check deployment status    |
| Update Image            | `kubectl set image deployment/<name> <container>=<image>`             | Update container version   |
| Edit Deployment         | `kubectl edit deployment/<name>`                                      | Manual change              |
| Check Rollout Status    | `kubectl rollout status deployment/<name>`                            | Monitor update progress    |
| View ReplicaSets        | `kubectl get rs`                                                      | List all replicasets       |
| View Pods               | `kubectl get po`                                                      | List pods under deployment |
| Rollout History         | `kubectl rollout history deployment/<name>`                           | See version history        |
| Annotate Change         | `kubectl annotate deployment/<name> kubernetes.io/change-cause="..."` | Record version notes       |

---

## ✅ **Key Takeaways**

* `kubectl set image` → fast, CLI-based updates.
* `kubectl edit deployment` → manual YAML edits for deep control.
* Rolling updates = **no downtime**.
* Every update creates a new **ReplicaSet** and **history entry**.
* Rollbacks are safe, fast, and tracked by Kubernetes automatically.

---
