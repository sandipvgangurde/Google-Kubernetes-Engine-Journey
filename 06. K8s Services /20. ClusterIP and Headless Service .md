# ☁️ **GCP Google Kubernetes Engine (GKE) Headless Service**

---

### 🏷️ **Title**

**GCP Google Kubernetes Engine GKE Headless Service**

### 🧾 **Description**

**Implement GCP Google Kubernetes Engine GKE Headless Service**

---

## ⚙️ **Step-00: Pre-requisites**

Before we begin, ensure your **GKE Cluster** is ready and `kubectl` is configured correctly.
Let's verify everything! 🧩

---

### 🧠 **Verify GKE Cluster Setup**

```bash
# Configure kubeconfig for kubectl
gcloud container clusters get-credentials <CLUSTER-NAME> --region <REGION> --project <PROJECT>
```

💡 **Replace Values:**

* `CLUSTER-NAME`
* `REGION`
* `PROJECT`

---

### ✅ **Example Command**

```bash
gcloud container clusters get-credentials standard-public-cluster-1 --region us-central1 --project kdaida123
```

---

### 📋 **List GKE Kubernetes Worker Nodes**

```bash
kubectl get nodes
```

---

## 🚀 **Step-01: Introduction**

We are going to **implement** and **understand** two types of services in Kubernetes:

1. **ClusterIP Service**
2. **Headless Service**

🧠 The focus here is to **understand Headless Service in detail** — how it differs from ClusterIP and when to use it.

---

## 🧱 **Step-02: 01-kubernetes-deployment.yaml**

### 📄 **File:** `01-kubernetes-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment 
metadata: #Dictionary
  name: myapp1-deployment
spec: # Dictionary
  replicas: 4
  selector:
    matchLabels:
      app: myapp1
  template:  
    metadata: # Dictionary
      name: myapp1-pod
      labels: # Dictionary
        app: myapp1  # Key value pairs
    spec:
      containers: # List
        - name: myapp1-container
          #image: stacksimplify/kubenginx:1.0.0
          image: us-docker.pkg.dev/google-samples/containers/gke/hello-app:2.0
          ports: 
            - containerPort: 8080
```

---

### 🧩 **Deployment Summary**

| ⚙️ Field          | 🧾 Description                                         |
| ----------------- | ------------------------------------------------------ |
| **replicas**      | 4 pods will be created                                 |
| **image**         | `hello-app:2.0` (Google sample app)                    |
| **containerPort** | 8080                                                   |
| **selector**      | Matches pods labeled `app: myapp1`                     |
| **purpose**       | Backend pods for testing ClusterIP & Headless services |

---

## 🌐 **Step-03: 02-kubernetes-clusterip-service.yaml**

### 📄 **File:** `02-kubernetes-clusterip-service.yaml`

```yaml
apiVersion: v1
kind: Service 
metadata:
  name: myapp1-cip-service
spec:
  type: ClusterIP # ClusterIP, # NodePort, # LoadBalancer, # ExternalName
  selector:
    app: myapp1
  ports: 
    - name: http
      port: 80 # Service Port
      targetPort: 8080 # Container Port
```

---

### 🧠 **Understanding ClusterIP Service**

| 🔧 Property          | 💡 Description                                  |
| -------------------- | ----------------------------------------------- |
| **type: ClusterIP**  | Default internal service within the cluster     |
| **port: 80**         | Port exposed inside cluster                     |
| **targetPort: 8080** | Port inside the container                       |
| **selector**         | Routes traffic to pods with label `app: myapp1` |

🌀 **Flow:**
User (inside cluster) → `myapp1-cip-service` → Pod (8080)

---

## 🔍 **Step-04: 03-kubernetes-headless-service.yaml**

### 📄 **File:** `03-kubernetes-headless-service.yaml`

💥 **VERY IMPORTANT NOTE** 💥
When using **Headless Service**, use the **same value** for both `port` and `targetPort`.

> **Headless Service** directly resolves DNS to Pod IP addresses — no ClusterIP proxying.

---

```yaml
apiVersion: v1
kind: Service 
metadata:
  name: myapp1-headless-service
spec:
  #type: ClusterIP # ClusterIP, # NodePort, # LoadBalancer, # ExternalName
  clusterIP: None
  selector:
    app: myapp1
  ports: 
    - name: http
      port: 8080 # Service Port
      targetPort: 8080 # Container Port
```

---

### 🧩 **Headless Service Breakdown**

| ⚙️ Field            | 📘 Description                                       |
| ------------------- | ---------------------------------------------------- |
| **clusterIP: None** | Makes the service headless                           |
| **port**            | Must match `targetPort` (8080)                       |
| **selector**        | Connects to pods with label `app: myapp1`            |
| **DNS behavior**    | Directly resolves service name to individual Pod IPs |

---

### 🌐 **Visual Concept**

```text
[ClusterIP Service]
Client → Service (Virtual IP) → Pod IP

[Headless Service]
Client → DNS lookup → Pod IPs directly
```

---

## 🧩 **Step-05: Deploy Kubernetes Manifests**

```bash
# Deploy Kubernetes Manifests
kubectl apply -f 01-kube-manifests

# List Deployments
kubectl get deploy

# List Pods
kubectl get pods
kubectl get pods -o wide
```

---

### 🔎 **Observation**

🧠 Make a note of **Pod IPs**.
You’ll need these when testing the **Headless Service**.

---

### 🧾 **List Services**

```bash
kubectl get svc
```

---

#### **Observation:**

1️⃣ The **CLUSTER-IP** will be `None` for the Headless Service.

---

### 🧰 **Sample Output**

```bash
NAME                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes                ClusterIP   10.24.0.1    <none>        443/TCP   135m
myapp1-cip-service        ClusterIP   10.24.2.34   <none>        80/TCP    4m9s
myapp1-headless-service   ClusterIP   None         <none>        80/TCP    4m9s
```

---

## 🧪 **Step-06: Review Curl Kubernetes Manifests**

📁 **Project Folder:** `02-kube-manifests-curl`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
spec:
  containers:
  - name: curl
    image: curlimages/curl 
    command: [ "sleep", "600" ]
```

This pod will help us test both the **ClusterIP** and **Headless Service** internally.

---

## 🔍 **Step-07: Deploy Curl Pod & Verify Services**

### 🧠 **Deploy and Test**

```bash
# Deploy curl-pod
kubectl apply -f 02-kube-manifests-curl

# List Services
kubectl get svc
```

---

### 🌍 **Kubernetes Full DNS Format**

```
<service-name>.<namespace>.svc.cluster.local
```

---

### 🧩 **Open Shell in Curl Pod**

```bash
kubectl exec -it curl-pod -- sh
```

---

#### 🔹 **ClusterIP Service Tests**

```bash
nslookup myapp1-cip-service.default.svc.cluster.local
curl myapp1-cip-service.default.svc.cluster.local
```

---

##### **Sample Output (ClusterIP Service)**

```bash
$ nslookup myapp1-cip-service.default.svc.cluster.local
Server:		10.24.0.10
Address:	10.24.0.10:53

Name:	myapp1-cip-service.default.svc.cluster.local
Address: 10.24.2.34
```

🧠 **Observation:**
The DNS resolves to a **single ClusterIP**, not Pod IPs.

---

#### 🔹 **Headless Service Tests**

```bash
nslookup myapp1-headless-service.default.svc.cluster.local
curl myapp1-headless-service.default.svc.cluster.local:8080
```

---

##### **Sample Output (Headless Service)**

```bash
$ nslookup myapp1-headless-service.default.svc.cluster.local
Server:		10.24.0.10
Address:	10.24.0.10:53

Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.0.25
Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.0.26
Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.1.28
Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.1.29
```

---

### 📘 **Observation:**

1️⃣ No specific IP for the **Headless Service** (ClusterIP = None).
2️⃣ DNS resolution maps **directly to Pod IPs**.
3️⃣ You must use the **same port** as the **Container Port** (`8080`).
🔥 (**VERY VERY IMPORTANT!**)

---

### 🧭 **Visual Summary**

```text
ClusterIP Service:
Client → 10.24.2.34 → Pods

Headless Service:
Client → DNS (Pod IPs: 10.20.x.x) → Pods directly
```

---

## 🧹 **Step-08: Clean-Up**

### ⚙️ **Commands**

```bash
# Delete Kubernetes Resources
kubectl delete -f 01-kube-manifests

# Delete Kubernetes Resources - Curl Pod
kubectl delete -f 02-kube-manifests-curl
```

---

### ✅ **Cleanup Summary**

| Resource                       | Status     |
| ------------------------------ | ---------- |
| Deployment                     | Deleted 🧹 |
| Services (ClusterIP, Headless) | Removed 🧩 |
| Curl Pod                       | Deleted 🧽 |

---

## 📚 **Concept Recap Table**

| 🔢 Step | 🧠 Description                   | 📘 Key Outcome            |
| ------- | -------------------------------- | ------------------------- |
| 00      | Verify GKE Cluster               | kubeconfig + nodes ready  |
| 01      | Understand ClusterIP vs Headless | Concept clarity           |
| 02–04   | Define Deployment & Services     | YAML manifests ready      |
| 05      | Deploy & Observe                 | Pods and Services running |
| 06–07   | Test with curl-pod               | DNS & traffic validation  |
| 08      | Clean up                         | Environment reset         |

---

## 🧩 **Visual Flow Summary**

```text
Pods (myapp1) 🧱🧱🧱🧱
   ↑           ↑
   |           |
ClusterIP 🌀   Headless (None) 🚪
   |           |
   ↓           ↓
curl-pod 🔍 (Testing Client)
```

---

### 🏁 **End of SOP**

✅ You have successfully:

* Deployed a **GKE application** with both **ClusterIP and Headless Services**
* Verified **DNS behavior** differences 🔍
* Used **curl pod** for internal testing 🧰
* Cleaned up all Kubernetes resources 🧹

---
