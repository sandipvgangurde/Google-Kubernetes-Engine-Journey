# â˜ï¸ **GCP Google Kubernetes Engine (GKE) Headless Service**

---

### ğŸ·ï¸ **Title**

**GCP Google Kubernetes Engine GKE Headless Service**

### ğŸ§¾ **Description**

**Implement GCP Google Kubernetes Engine GKE Headless Service**

---

## âš™ï¸ **Step-00: Pre-requisites**

Before we begin, ensure your **GKE Cluster** is ready and `kubectl` is configured correctly.
Let's verify everything! ğŸ§©

---

### ğŸ§  **Verify GKE Cluster Setup**

```bash
# Configure kubeconfig for kubectl
gcloud container clusters get-credentials <CLUSTER-NAME> --region <REGION> --project <PROJECT>
```

ğŸ’¡ **Replace Values:**

* `CLUSTER-NAME`
* `REGION`
* `PROJECT`

---

### âœ… **Example Command**

```bash
gcloud container clusters get-credentials standard-public-cluster-1 --region us-central1 --project kdaida123
```

---

### ğŸ“‹ **List GKE Kubernetes Worker Nodes**

```bash
kubectl get nodes
```

---

## ğŸš€ **Step-01: Introduction**

We are going to **implement** and **understand** two types of services in Kubernetes:

1. **ClusterIP Service**
2. **Headless Service**

ğŸ§  The focus here is to **understand Headless Service in detail** â€” how it differs from ClusterIP and when to use it.

---

## ğŸ§± **Step-02: 01-kubernetes-deployment.yaml**

### ğŸ“„ **File:** `01-kubernetes-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment 
metadata: #Dictionary
  name: myapp1-deployment
spec: # Dictionary
  replicas: 4
  selector:
    matchLabels:
      app: myapp1
  template:  
    metadata: # Dictionary
      name: myapp1-pod
      labels: # Dictionary
        app: myapp1  # Key value pairs
    spec:
      containers: # List
        - name: myapp1-container
          #image: stacksimplify/kubenginx:1.0.0
          image: us-docker.pkg.dev/google-samples/containers/gke/hello-app:2.0
          ports: 
            - containerPort: 8080
```

---

### ğŸ§© **Deployment Summary**

| âš™ï¸ Field          | ğŸ§¾ Description                                         |
| ----------------- | ------------------------------------------------------ |
| **replicas**      | 4 pods will be created                                 |
| **image**         | `hello-app:2.0` (Google sample app)                    |
| **containerPort** | 8080                                                   |
| **selector**      | Matches pods labeled `app: myapp1`                     |
| **purpose**       | Backend pods for testing ClusterIP & Headless services |

---

## ğŸŒ **Step-03: 02-kubernetes-clusterip-service.yaml**

### ğŸ“„ **File:** `02-kubernetes-clusterip-service.yaml`

```yaml
apiVersion: v1
kind: Service 
metadata:
  name: myapp1-cip-service
spec:
  type: ClusterIP # ClusterIP, # NodePort, # LoadBalancer, # ExternalName
  selector:
    app: myapp1
  ports: 
    - name: http
      port: 80 # Service Port
      targetPort: 8080 # Container Port
```

---

### ğŸ§  **Understanding ClusterIP Service**

| ğŸ”§ Property          | ğŸ’¡ Description                                  |
| -------------------- | ----------------------------------------------- |
| **type: ClusterIP**  | Default internal service within the cluster     |
| **port: 80**         | Port exposed inside cluster                     |
| **targetPort: 8080** | Port inside the container                       |
| **selector**         | Routes traffic to pods with label `app: myapp1` |

ğŸŒ€ **Flow:**
User (inside cluster) â†’ `myapp1-cip-service` â†’ Pod (8080)

---

## ğŸ” **Step-04: 03-kubernetes-headless-service.yaml**

### ğŸ“„ **File:** `03-kubernetes-headless-service.yaml`

ğŸ’¥ **VERY IMPORTANT NOTE** ğŸ’¥
When using **Headless Service**, use the **same value** for both `port` and `targetPort`.

> **Headless Service** directly resolves DNS to Pod IP addresses â€” no ClusterIP proxying.

---

```yaml
apiVersion: v1
kind: Service 
metadata:
  name: myapp1-headless-service
spec:
  #type: ClusterIP # ClusterIP, # NodePort, # LoadBalancer, # ExternalName
  clusterIP: None
  selector:
    app: myapp1
  ports: 
    - name: http
      port: 8080 # Service Port
      targetPort: 8080 # Container Port
```

---

### ğŸ§© **Headless Service Breakdown**

| âš™ï¸ Field            | ğŸ“˜ Description                                       |
| ------------------- | ---------------------------------------------------- |
| **clusterIP: None** | Makes the service headless                           |
| **port**            | Must match `targetPort` (8080)                       |
| **selector**        | Connects to pods with label `app: myapp1`            |
| **DNS behavior**    | Directly resolves service name to individual Pod IPs |

---

### ğŸŒ **Visual Concept**

```text
[ClusterIP Service]
Client â†’ Service (Virtual IP) â†’ Pod IP

[Headless Service]
Client â†’ DNS lookup â†’ Pod IPs directly
```

---

## ğŸ§© **Step-05: Deploy Kubernetes Manifests**

```bash
# Deploy Kubernetes Manifests
kubectl apply -f 01-kube-manifests

# List Deployments
kubectl get deploy

# List Pods
kubectl get pods
kubectl get pods -o wide
```

---

### ğŸ” **Observation**

ğŸ§  Make a note of **Pod IPs**.
Youâ€™ll need these when testing the **Headless Service**.

---

### ğŸ§¾ **List Services**

```bash
kubectl get svc
```

---

#### **Observation:**

1ï¸âƒ£ The **CLUSTER-IP** will be `None` for the Headless Service.

---

### ğŸ§° **Sample Output**

```bash
NAME                      TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes                ClusterIP   10.24.0.1    <none>        443/TCP   135m
myapp1-cip-service        ClusterIP   10.24.2.34   <none>        80/TCP    4m9s
myapp1-headless-service   ClusterIP   None         <none>        80/TCP    4m9s
```

---

## ğŸ§ª **Step-06: Review Curl Kubernetes Manifests**

ğŸ“ **Project Folder:** `02-kube-manifests-curl`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
spec:
  containers:
  - name: curl
    image: curlimages/curl 
    command: [ "sleep", "600" ]
```

This pod will help us test both the **ClusterIP** and **Headless Service** internally.

---

## ğŸ” **Step-07: Deploy Curl Pod & Verify Services**

### ğŸ§  **Deploy and Test**

```bash
# Deploy curl-pod
kubectl apply -f 02-kube-manifests-curl

# List Services
kubectl get svc
```

---

### ğŸŒ **Kubernetes Full DNS Format**

```
<service-name>.<namespace>.svc.cluster.local
```

---

### ğŸ§© **Open Shell in Curl Pod**

```bash
kubectl exec -it curl-pod -- sh
```

---

#### ğŸ”¹ **ClusterIP Service Tests**

```bash
nslookup myapp1-cip-service.default.svc.cluster.local
curl myapp1-cip-service.default.svc.cluster.local
```

---

##### **Sample Output (ClusterIP Service)**

```bash
$ nslookup myapp1-cip-service.default.svc.cluster.local
Server:		10.24.0.10
Address:	10.24.0.10:53

Name:	myapp1-cip-service.default.svc.cluster.local
Address: 10.24.2.34
```

ğŸ§  **Observation:**
The DNS resolves to a **single ClusterIP**, not Pod IPs.

---

#### ğŸ”¹ **Headless Service Tests**

```bash
nslookup myapp1-headless-service.default.svc.cluster.local
curl myapp1-headless-service.default.svc.cluster.local:8080
```

---

##### **Sample Output (Headless Service)**

```bash
$ nslookup myapp1-headless-service.default.svc.cluster.local
Server:		10.24.0.10
Address:	10.24.0.10:53

Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.0.25
Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.0.26
Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.1.28
Name:	myapp1-headless-service.default.svc.cluster.local
Address: 10.20.1.29
```

---

### ğŸ“˜ **Observation:**

1ï¸âƒ£ No specific IP for the **Headless Service** (ClusterIP = None).
2ï¸âƒ£ DNS resolution maps **directly to Pod IPs**.
3ï¸âƒ£ You must use the **same port** as the **Container Port** (`8080`).
ğŸ”¥ (**VERY VERY IMPORTANT!**)

---

### ğŸ§­ **Visual Summary**

```text
ClusterIP Service:
Client â†’ 10.24.2.34 â†’ Pods

Headless Service:
Client â†’ DNS (Pod IPs: 10.20.x.x) â†’ Pods directly
```

---

## ğŸ§¹ **Step-08: Clean-Up**

### âš™ï¸ **Commands**

```bash
# Delete Kubernetes Resources
kubectl delete -f 01-kube-manifests

# Delete Kubernetes Resources - Curl Pod
kubectl delete -f 02-kube-manifests-curl
```

---

### âœ… **Cleanup Summary**

| Resource                       | Status     |
| ------------------------------ | ---------- |
| Deployment                     | Deleted ğŸ§¹ |
| Services (ClusterIP, Headless) | Removed ğŸ§© |
| Curl Pod                       | Deleted ğŸ§½ |

---

## ğŸ“š **Concept Recap Table**

| ğŸ”¢ Step | ğŸ§  Description                   | ğŸ“˜ Key Outcome            |
| ------- | -------------------------------- | ------------------------- |
| 00      | Verify GKE Cluster               | kubeconfig + nodes ready  |
| 01      | Understand ClusterIP vs Headless | Concept clarity           |
| 02â€“04   | Define Deployment & Services     | YAML manifests ready      |
| 05      | Deploy & Observe                 | Pods and Services running |
| 06â€“07   | Test with curl-pod               | DNS & traffic validation  |
| 08      | Clean up                         | Environment reset         |

---

## ğŸ§© **Visual Flow Summary**

```text
Pods (myapp1) ğŸ§±ğŸ§±ğŸ§±ğŸ§±
   â†‘           â†‘
   |           |
ClusterIP ğŸŒ€   Headless (None) ğŸšª
   |           |
   â†“           â†“
curl-pod ğŸ” (Testing Client)
```

---

### ğŸ **End of SOP**

âœ… You have successfully:

* Deployed a **GKE application** with both **ClusterIP and Headless Services**
* Verified **DNS behavior** differences ğŸ”
* Used **curl pod** for internal testing ğŸ§°
* Cleaned up all Kubernetes resources ğŸ§¹

---
