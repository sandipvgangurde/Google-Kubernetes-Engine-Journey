# 🎯 **GCP Google Kubernetes Engine (GKE) NodePort Service**

---

### 🧩 **Title**

**GCP Google Kubernetes Engine GKE NodePort Service**

### 📝 **Description**

**Implement GCP Google Kubernetes Engine GKE NodePort Service**

---

## ⚙️ **Step-00: Pre-requisites**

Before starting, ensure that your **GKE cluster** is running and that **kubectl** is configured properly.

---

### ✅ **Verify GKE Cluster & kubeconfig**

```bash
# Configure kubeconfig for kubectl
gcloud container clusters get-credentials <CLUSTER-NAME> --region <REGION> --project <PROJECT>
```

👉 **Replace values:**

* `<CLUSTER-NAME>`
* `<REGION>`
* `<PROJECT>`

---

### 🧠 **Example Command**

```bash
gcloud container clusters get-credentials standard-public-cluster-1 --region us-central1 --project kdaida123
```

---

### 📋 **Verify GKE Worker Nodes**

```bash
# List GKE Kubernetes Worker Nodes
kubectl get nodes

# List GKE Kubernetes Worker Nodes with -o wide option
kubectl get nodes -o wide
```

---

### 🔍 **Observation**

1️⃣ You should see **External-IP Address** (Public IP accessible via Internet).
2️⃣ This **External-IP** is essential for testing the **NodePort Service** on GKE.

---

### 🌐 **Visual Concept**

```text
User (Browser) 🌍
        |
        v
  GKE Worker Node 🧩
 (Has External IP)
        |
   NodePort Service 🚪 (Port 30080)
        |
        v
   Kubernetes Pod 🧱
```

---

## 🚀 **Step-01: Introduction**

Implement **Kubernetes NodePort Service** on **Google Kubernetes Engine (GKE)**.

---

## 🧱 **Step-02: 01-kubernetes-deployment.yaml**

### 📄 **File:** `01-kubernetes-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment 
metadata: #Dictionary
  name: myapp1-deployment
spec: # Dictionary
  replicas: 2
  selector:
    matchLabels:
      app: myapp1
  template:  
    metadata: # Dictionary
      name: myapp1-pod
      labels: # Dictionary
        app: myapp1  # Key value pairs
    spec:
      containers: # List
        - name: myapp1-container
          image: stacksimplify/kubenginx:1.0.0
          ports: 
            - containerPort: 80
```

---

### 🧩 **Deployment Details**

| 🔧 Field          | 💬 Description                                |
| ----------------- | --------------------------------------------- |
| **apiVersion**    | `apps/v1` (Deployment API version)            |
| **kind**          | Defines resource type as `Deployment`         |
| **metadata.name** | Name of Deployment → `myapp1-deployment`      |
| **replicas**      | Ensures 2 Pods always running                 |
| **selector**      | Matches Pods with label `app: myapp1`         |
| **containerPort** | Container listens on port `80`                |
| **image**         | `stacksimplify/kubenginx:1.0.0` (Nginx image) |

---

## 🌐 **Step-03: 02-kubernetes-nodeport-service.yaml**

> 💡 If you don’t specify `nodePort: 30080`, it will dynamically assign one port from range **30000–32768**

---

### 📄 **File:** `02-kubernetes-nodeport-service.yaml`

```yaml
apiVersion: v1
kind: Service 
metadata:
  name: myapp1-nodeport-service
spec:
  type: NodePort # clusterIP, # NodePort, # LoadBalancer, # ExternalName
  selector:
    app: myapp1
  ports: 
    - name: http
      port: 80 # Service Port
      targetPort: 80 # Container Port
      nodePort: 30080 # NodePort (Optional)(Node Port Range: 30000-32768)
```

---

### ⚙️ **NodePort Service Breakdown**

| 🧱 Field       | 📘 Description                                     |
| -------------- | -------------------------------------------------- |
| **type**       | `NodePort` exposes service on a port on every node |
| **port**       | Cluster-internal service port (`80`)               |
| **targetPort** | Container port inside the Pod (`80`)               |
| **nodePort**   | External Node Port (`30080`) for external access   |
| **selector**   | Connects service to Pods with label `app: myapp1`  |

---

### 🌈 **Visual Flow: NodePort Architecture**

```text
User Browser 🌍
    |
    v
Node External IP:30080 🌐  <-- (Firewall must allow this)
    |
    v
Service (NodePort) 🚪
    |
    v
Pod(s) running Nginx 🧱
```

---

## ⚙️ **Step-04: Deploy Kubernetes Manifests**

```bash
# Deploy Kubernetes Manifests
kubectl apply -f kube-manifests

# List Deployments
kubectl get deploy

# List Pods
kubectl get po

# List Services
kubectl get svc
```

---

### 🧾 **Expected Output Example**

| Resource   | Status                             |
| ---------- | ---------------------------------- |
| Deployment | 2/2 Pods Running ✅                 |
| Service    | NodePort created on port `30080` ✅ |
| Pods       | `myapp1-pod` instances running ✅   |

---

## 🌍 **Step-05: Access Application**

```bash
# List Kubernetes Worker Node with -o wide
kubectl get nodes -o wide
```

---

### 🔍 **Observation**

1️⃣ Make a note of any **Node External-IP (Public IP Address)**

---

### 🌐 **Access Application**

```bash
http://<NODE-EXTERNAL-IP>:<NodePort>
# Example
http://104.154.52.12:30080
```

---

### ⚠️ **Observation**

1️⃣ This should **fail initially**, as firewall rules do not yet allow traffic on port `30080`.

---

## 🔥 **Step-06: Create Firewall Rule**

### ⚙️ **Commands**

```bash
# Create Firewall Rule
gcloud compute firewall-rules create fw-rule-gke-node-port \
    --allow tcp:NODE_PORT
```

---

### 🧩 **Example**

```bash
# Replace NODE_PORT
gcloud compute firewall-rules create fw-rule-gke-node-port \
    --allow tcp:30080   
```

---

### 📋 **List Firewall Rules**

```bash
gcloud compute firewall-rules list
```

---

### 🔐 **Firewall Rule Explanation**

| 🔧 Option          | 💬 Description                                 |
| ------------------ | ---------------------------------------------- |
| **Rule Name**      | `fw-rule-gke-node-port`                        |
| **Allow Protocol** | TCP                                            |
| **Port**           | `30080`                                        |
| **Purpose**        | Allow external traffic to GKE NodePort service |

---

## 🌎 **Step-07: Access Application**

```bash
# List Kubernetes Worker Node with -o wide
kubectl get nodes -o wide
```

---

### 🔍 **Observation**

1️⃣ Make a note of any **Node External-IP (Public IP Address)**

---

### 🌐 **Access Application**

```bash
http://<NODE-EXTERNAL-IP>:<NodePort>
# Example
http://104.154.52.12:30080
```

---

### ✅ **Observation**

1️⃣ This time it should **PASS** — application will be successfully accessible from the browser 🎉

---

### 💡 **Visual Confirmation Flow**

```text
Firewall ✅  --->  GKE Node External IP 🌍  --->  NodePort 30080 🚪  --->  Pod 🧱
```

---

## 🧹 **Step-08: Clean-Up**

### ⚙️ **Commands**

```bash
# Delete Kubernetes Resources
kubectl delete -f kube-manifests

# Delete NodePort Service Firewall Rule
gcloud compute firewall-rules delete fw-rule-gke-node-port

# List Firewall Rules
gcloud compute firewall-rules list
```

---

### 🧾 **Cleanup Verification**

| 🧩 Resource       | 💬 Expected Result |
| ----------------- | ------------------ |
| **Pods**          | Deleted            |
| **Deployment**    | Removed            |
| **Service**       | NodePort deleted   |
| **Firewall Rule** | Deleted from GCP   |

---

## 📚 **Summary Table**

| 🧭 Step   | 🧠 Description             | 🧾 Key Output                       |
| --------- | -------------------------- | ----------------------------------- |
| **00**    | Pre-requisites             | GKE cluster + kubeconfig setup      |
| **01–03** | Deployment + NodePort YAML | Creates 2 Pods + NodePort Service   |
| **04**    | Deploy Manifests           | All Kubernetes resources up         |
| **05**    | Access App (Fails)         | Firewall not open                   |
| **06–07** | Create Firewall + Test     | NodePort app accessible             |
| **08**    | Cleanup                    | Deletes resources and firewall rule |

---

### 🎓 **Complete Workflow Diagram**

```text
[01-kubernetes-deployment.yaml] --> Creates --> 2 Pods (myapp1)
                                  |
                                  v
[02-kubernetes-nodeport-service.yaml] --> Exposes Pods on NodePort 30080
                                  |
                                  v
Firewall Rule (fw-rule-gke-node-port) --> Allows external traffic 🌍
                                  |
                                  v
Access via http://<Node-External-IP>:30080 🚀
```

---

### 🏁 **End of SOP**

✅ You have successfully:

* Configured **kubectl** with your GKE cluster ☁️
* Created a **Deployment** and **NodePort Service** 🧩
* Opened **GCP Firewall** for NodePort access 🔥
* Accessed your app using **Node External IP + NodePort** 🌐
* Cleaned up all resources 🧹

---

