# üì¶ **GCP Google Kubernetes Engine (GKE) StorageClasses (Dynamic Provisioning)**

---

### üè∑Ô∏è **Title**

**Implementing GCP-specific StorageClasses and Dynamic Provisioning in GKE**

### üßæ **Description**

This SOP will guide you through creating **GKE-specific StorageClasses** for **dynamic provisioning** of PersistentVolumes (PVs) in a Google Kubernetes Engine (GKE) cluster.

---

## ‚öôÔ∏è **Step-00: Pre-requisites**

Before working with **StorageClasses** and **Dynamic Provisioning** of PersistentVolumes on **Google Kubernetes Engine (GKE)**, ensure the following:

* A **Google Cloud Project** is set up.
* **Google Kubernetes Engine (GKE)** cluster is already created and accessible.
* **kubectl** is properly configured for your GKE cluster.

---

### üß† **Verify GKE Cluster Setup**

Ensure you can access the cluster from your terminal.

```bash
# Check the status of GKE nodes
kubectl get nodes
```

If your `kubectl` is not yet configured, use the following command to authenticate your session:

```bash
gcloud container clusters get-credentials <CLUSTER-NAME> --region <REGION> --project <PROJECT-ID>
```

Replace:

* `<CLUSTER-NAME>` with your GKE cluster name.
* `<REGION>` with the region where the cluster is located (e.g., `us-central1`).
* `<PROJECT-ID>` with your GCP project ID.

---

## üß± **Step-01: Introduction to GCP StorageClass and Dynamic Provisioning**

In GCP, dynamic provisioning of **PersistentVolumes (PVs)** is managed through **StorageClasses**. When a **PersistentVolumeClaim (PVC)** is created, Kubernetes will provision a PV automatically based on the **StorageClass** parameters.

---

### **What is a GCP-specific StorageClass?**

A **StorageClass** defines the characteristics of the storage. For GKE, we commonly use **GCEPersistentDisk (GCE PD)** as the **provisioner** for dynamic provisioning.

#### Key Concepts:

* **Provisioner:** The storage provisioner in GKE is typically `kubernetes.io/gce-pd` (for Google Cloud Persistent Disk).
* **Reclaim Policy:** Defines the behavior when the PVC is deleted (e.g., `Retain`, `Delete`).
* **Volume Binding Mode:** `WaitForFirstConsumer` ensures that the volume is only provisioned once a Pod is scheduled to use it.

---

## üß© **Step-02: Create a GCP-specific StorageClass for Dynamic Provisioning**

Create a **StorageClass** YAML file for GCEPersistentDisk to provision dynamic storage in GKE.

### üìÑ **Create GCP-specific StorageClass YAML (Example for GCE Persistent Disk):**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard-storage
provisioner: kubernetes.io/gce-pd  # GKE GCE Persistent Disk provisioner
parameters:
  type: pd-standard  # type of disk (pd-standard or pd-ssd)
  fsType: ext4        # filesystem type for the disk
reclaimPolicy: Retain  # Retain the volume after PVC deletion
volumeBindingMode: WaitForFirstConsumer  # Provision volume when a pod is scheduled
```

### üß© **Explanation of Fields:**

| Field                 | Description                                                                                              |
| --------------------- | -------------------------------------------------------------------------------------------------------- |
| **provisioner**       | The provisioner for GCP (Google Cloud Persistent Disk).                                                  |
| **parameters**        | Specifies disk type (`pd-standard` or `pd-ssd`) and filesystem type.                                     |
| **reclaimPolicy**     | Defines what happens when the PVC is deleted (e.g., `Retain` keeps the volume).                          |
| **volumeBindingMode** | Ensures that the volume is created only when the pod is scheduled (recommended for multi-zone clusters). |

---

### üî® **Create the StorageClass**

```bash
# Apply the StorageClass YAML file
kubectl apply -f storageclass-gce-pd.yaml

# Verify the StorageClass creation
kubectl get storageclass
```

---

## üß© **Step-03: Create a PersistentVolumeClaim (PVC) for GCP StorageClass**

After creating the **StorageClass**, you can now create a **PersistentVolumeClaim (PVC)** to request storage dynamically.

### üìÑ **Create PVC YAML:**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-gcp-pvc
spec:
  accessModes:
    - ReadWriteOnce  # Only one node can access the volume
  resources:
    requests:
      storage: 5Gi  # Requested size for the volume
  storageClassName: standard-storage  # Reference to the StorageClass we created above
```

### üß© **Explanation of PVC Fields:**

| Field                          | Description                                                                  |
| ------------------------------ | ---------------------------------------------------------------------------- |
| **accessModes**                | The access mode for the PVC (should match the PV).                           |
| **resources.requests.storage** | The amount of storage requested (must be less than or equal to PV capacity). |
| **storageClassName**           | This refers to the `StorageClass` created above (GCE-specific).              |

---

### üî® **Create PersistentVolumeClaim (PVC)**

```bash
# Apply the PVC YAML file
kubectl apply -f my-gcp-pvc.yaml

# Check PVC status and binding
kubectl get pvc
```

You should see the **PVC** in **Bound** state once the dynamic provisioning completes.

---

## üß© **Step-04: Use PVC in a Pod**

Now that your **PVC** is created and bound to a **PersistentVolume**, let‚Äôs use this PVC in a Pod.

### üìÑ **Pod YAML Definition:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: my-app-container
    image: nginx
    volumeMounts:
    - mountPath: "/usr/share/nginx/html"
      name: my-pvc-volume
  volumes:
  - name: my-pvc-volume
    persistentVolumeClaim:
      claimName: my-gcp-pvc  # Reference to the PVC we created earlier
```

---

### üî® **Create Pod with PVC Mounted**

```bash
# Apply the Pod YAML
kubectl apply -f my-app-pod.yaml

# Verify Pod status
kubectl get pods
```

---

### üìç **Verify Storage Access in Pod**

Once the Pod is running, you can verify that the volume is properly mounted by accessing the container:

```bash
# Open a shell inside the Pod
kubectl exec -it my-app -- sh

# List contents in the mounted volume directory
ls /usr/share/nginx/html
```

You should see the data available in the mounted directory.

---

## üß© **Step-05: Resize PVC (Optional)**

In some cases, you may need to resize the **PVC**. This is possible with GCP‚Äôs persistent disks.

### üî® **Resize PVC Command:**

1. **Edit the PVC:**

```bash
kubectl edit pvc my-gcp-pvc
```

2. **Change the storage size**:

```yaml
resources:
  requests:
    storage: 10Gi  # New size for the volume
```

3. **Save and exit**.

4. **Verify the resized PVC**:

```bash
kubectl get pvc my-gcp-pvc
```

The **PVC** should now show the updated size.

---

## üß© **Step-06: Clean-Up Storage Resources**

If you no longer need the resources, you can delete the **PVC**, **Pod**, and **StorageClass** to clean up.

### üî® **Delete PVC, Pod, and StorageClass:**

```bash
# Delete the PVC
kubectl delete pvc my-gcp-pvc

# Delete the Pod
kubectl delete pod my-app

# Delete the StorageClass
kubectl delete storageclass standard-storage
```

---

## üìò **Key Takeaways:**

* **StorageClass** is used to define the dynamic provisioning of **PersistentVolumes (PVs)** on GKE using Google Cloud‚Äôs **Persistent Disk (GCE PD)**.
* **Dynamic Provisioning** ensures that a PV is automatically created when a **PersistentVolumeClaim (PVC)** is made.
* **GCP-specific provisioner** (`kubernetes.io/gce-pd`) allows Kubernetes to create **PersistentVolumes** backed by **Google Cloud Persistent Disks**.
* **GKE** supports flexible storage options including `pd-standard` and `pd-ssd` types, making it scalable for different use cases.
* **PVC** automatically binds to a dynamically provisioned PV based on the **StorageClass**.

---

### üåê **Visual Summary of GCP StorageClass and PVC Flow**

```text
User ‚Üí PVC ‚Üí GCP StorageClass (GCE PD) ‚Üí PV (Provisioned on GCP) ‚Üí Pod (Mounted Volume)
```

---

## üßπ **Clean-up Table**

| Action         | Command                         |
| -------------- | ------------------------------- |
| Delete PVC     | `kubectl delete pvc my-gcp-pvc` |
| Delete Pod     | `kubectl delete pod my-app`     |
| Delete Storage |                                 |


Class       | `kubectl delete storageclass standard-storage`   |

---
